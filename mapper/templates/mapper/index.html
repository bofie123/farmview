{% extends "mapper/base.html" %}

{% block index %}

  <section id='home-section' name='home-section'></section>
  <div id='home-wrap'>
    <div class='container'>
      <div class='row'>
        <div class='col-md-6 col-md-offset-3'>
          <h1>Farmview</h1>
        </div>
      </div><!--/row -->
    </div><!--/container -->
  </div><!--/home-wrap -->

  <section id='map-section' name='map-section'></section>
  <div id='map-wrap'>
    <div class='container-fluid'>
      <div class='row'>
        <div id='map' class='col-md-9'></div>
        <!-- query boxes go here -->
        <div id='query-sidebar' class='col-md-3'>
          <div id='query-area' class='form-group col-md-12'>
          </div>
          <br />
          <button id='submit-button' type='button' class='btn btn-primary btn-lg btn-block'>Submit</button>
        </div><!--/ query-sidebar -->
      </div><!--/row -->
    </div><!--/container -->
  </div><!--/map-wrap -->

  <script>
    // START TOGGLE MENU SETTINGS
    $('#menuToggle, .menu-close').click(function (e) {
      $('#menuToggle').toggleClass('active');
      $('body').toggleClass('body-push-toleft');
      $('#theMenu').toggleClass('menu-open');
    });

    $('#theMenu a').click(function (e) {
      $('i.menu-close').click();
    });
    // END TOGGLE MENU SETTINGS

    // START MAP SETTINGS
    var vis;
    var layers;

    var vizjson_url = '{{ config.vizjson_url }}';
    var pub_date = '{{ config.pub_date }}';
    var optional_note = '{{ config.optional_note }}';
    console.log('Loading CartoDB Viz JSON: ' + vizjson_url);
    console.log(pub_date);
    if (optional_note)
      console.log('Note: ' + optional_note);

    var cartodb_options = {
      layer_selector: false,
      shareable: false,
      title: false,
      description: false,
      search: true,
      zoomControl: true,
      loaderControl: true,
      center_lat: 36.9719,
      center_lon: -122.0264,
      zoom: 11,
      cartodb_logo: false,
      infowindow: true,
      time_slider: false,
      layer_selector: false,
      legends: true,
      https: true,
      scrollwheel: true,
      fullscreen: false,
      mobile_layout: true,
      force_mobile: false
      // gmaps_base_type: 'roadmap',
      // gmaps_style: null,
      // no_cdn: false
    };
    cartodb.createVis('map', vizjson_url, cartodb_options)
    .done(function (_vis, _layers) {
      vis = _vis;
      layers = _layers; // layers[0] is a torque layer where we don't have much control.
    });
    // END MAP SETTINGS

    // START QUERY SETTINGS
    function my_deserializer(str_arr) {
      var arr = [];
      for (var i = 0; i < str_arr.length; i++) {
        str_arr = str_arr.replace('&#39;', '"');
        str_arr = str_arr.replace('u"', '"'); // FOR UNICODE SUPPORT
      }
      arr = JSON.parse(str_arr);
      return arr;
    }

    function get_query_ui(q, c) {
      var ui = $('<div id="' + q.q_name + '-query-ui" class="checkbox query-ui"></div>');
      ui.append('<label>' + '<input id="' + q.q_name + '-chkbox" type="checkbox" class="query-group"/>' + q.q_name + '</label>');
      
      var operand;
      switch (q.q_type) {
        // TEXT
        case 'text':
        operand = $('<input id="' + q.q_name + '-operand" type="text" class="form-control operand-ui" placeholder="' + q.q_name + '" disabled />');
        break;

        // SELECT
        case 'select_one':
        if (c.length > 0) {
          operand = $('<select id="' + q.q_name + '-operand" class="form-control operand-ui" disabled />');
          operand.append('<option>- Select One -</option>');
          for (var i = 0; i < c.length; i++) {
            var option = $('<option>' + c[i].c_label_english + '</option>');
            operand.append(option);
          }
        }
        break;

        // CHECKBOX
        case 'select_multiple':
        operand = $('<div id="' + q.q_name + '-operand" class="checkbox disabled" />');
        for (var i = 0; i < c.length; i++) {
          var option = $('<label><input type="checkbox" value="" class="operand-ui" disabled>' + c[i].c_label_english + '</label><br/>');
          operand.append(option);
        }
        break;

        // NUMBER
        case 'decimal':
        case 'integer':
        break;

        // DATE
        case 'date':
        case 'today':
        break;

        // YOU DON'T WANT TO QUERY USING THESE FIELD TYPES
        case 'photo':
        case 'audio':
        case 'imei':
        case 'phonenumber':
        case 'start':
        case 'end':
        case 'geoshape':
        case 'geopoint':
        break;

        // ANYTHING ELSE?
        default:
        console.log('I don\'t know how to query ' + q.q_type);
        break;
      }

      ui.append(operand);

      return ui;
    }

    var q_data = my_deserializer('{{ q_data }}');
    var c_data = my_deserializer('{{ c_data }}');
    for (var i = 0; i<q_data.length; i++) {
      var question = q_data[i];
      var choices = [];
      for (var j=0; j<c_data.length; j++) {
        var choice = c_data[j];
        if (choice.q_name == question.q_name) {
          choices.push(choice);
        }
      }

      var ui = get_query_ui(question, choices);
      $('#query-area').append(ui);
    }

    // var fields = [];
    // var values = [];

    $('#query-area input[type=checkbox].query-group').click(function (e) {
      // var idstr = $(this).attr('id');
      // var field = idstr.split('-')[0];
      var checked = $(this).prop('checked');
      // var field_index = fields.indexOf(field);

      if (checked) { // CHECK
        // if (field_index >= 0) { // EXISTING FIELD
        //   fields.splice(field_index, 1); // REMOVE IT FIRST
        // }
        // fields.push(field); // PUSH IT

        // ENABLE OPERAND UI
        $(this).parent('label').parent('div').find('.operand-ui').prop('disabled', false);
        $(this).parent('label').parent('div').find('.operand-ui').removeClass('disabled');

        // PUSH EXISTING VALUE OPTIONS, IF ANY
        // var existing_single_val = $(this).parent('label').parent('div').find('.operand-ui').val();
        // if (existing_single_val && existing_single_val != '- Select One -') {
        //   console.log('existing ' + existing_single_val);
        //   values.push(existing_single_val);
        // }
        // else {
        //   alert($(this).parent('label').parent('div').find('.operand-ui').attr('id'));
        // }
      }
      else { // UNCHECK
        // fields.splice(field_index, 1); // REMOVE THE FIELD
        // values.splice(field_index, 1); // REMOVE THE VALUE

        // DISABLE QUERY VALUE OPTIONS
        $(this).parent('label').parent('div').find('.operand-ui').prop('disabled', true);
        $(this).parent('label').parent('div').find('.operand-ui').addClass('disabled');
      }

      // console.log(fields);
      // console.log(values);
    });

    $('#submit-button').click(function (e) {
      // COLLECT FIELD NAME

      // COLLECT OPERAND VALUE

      // SUBMIT
    });

    // $('#query-sidebar select').change(function (e) {
    //   var field = $(this).attr('id').split('_')[0];
    //   var value = $(this).val();
    //   if (value == '-- Select --') return;
    //   var field_index = fields.indexOf(field);
    //   values.splice(field_index, 1, value);

    //   console.log(fields);
    //   console.log(values);
    // });

    // TODO: SEND QUERY
    // var sql = new cartodb.SQL({ user: 'cartodb_user' });
    // sql.execute("SELECT * FROM table_name WHERE id > {{id}}", { id: 3 })
    // .done(function(data) {
    //   console.log(data.rows);
    // })
    // .error(function(errors) {
    //   // errors contains a list of errors
    //   console.log("errors:" + errors);
    // });
    // END QUERY SETTINGS
    
    // START
    // $('#menuToggle').click();
    // setTimeout(function () {
    //   $('#menuToggle').click();
    // }, 500);
    // END
  </script>

{% endblock %}
