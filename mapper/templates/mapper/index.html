{% extends "mapper/base.html" %}

{% block index %}

  <section id='home-section' name='home-section'></section>
  <div id='home-wrap'>
    <div class='container'>
      <div class='row'>
        <div class='col-md-6 col-md-offset-3'>
          <h1>Farmview</h1>
        </div>
      </div><!--/row -->
    </div><!--/container -->
  </div><!--/home-wrap -->

  <section id='map-section' name='map-section'></section>
  <div id='map-wrap'>
    <div class='container-fluid'>
      <div class='row'>
        <div id='map' class='col-md-9'></div>
        <!-- query boxes go here -->
        <div id='query-sidebar' class='col-md-3'>
          <div id='query-area' class='col-md-12'>
          </div>
          <!-- <div class='checkbox'>
            <label>
              <input id='zoning_query_chk' type='checkbox' />
              Zoning Category
            </label>
            <select id='zoning_query_slct' class='form-control' disabled>
              <option>-- Select --</option>
              <option>CA</option>
              <option>A</option>
              <option>AP</option>
              <option>RA</option>
              <option>RR</option>
              <option>R-1</option>
              <option>RB</option>
              <option>RM</option>
              <option>PA</option>
              <option>VA</option>
              <option>CT</option>
              <option>C-1</option>
              <option>C-2</option>
              <option>C-4</option>
              <option>M-1</option>
              <option>M-2</option>
              <option>M-3</option>
              <option>PR</option>
              <option>PF</option>
              <option>TP</option>
              <option>SU</option>
            </select>
          </div>
          <div class='checkbox'>
            <label>
              <input id='soil_query_chk' type='checkbox' />
              Soil Type
            </label>
            <select id='soil_query_slct' class='form-control' disabled>
              <option>-- Select --</option>
              <option>P</option>
              <option>S</option>
              <option>U</option>
              <option>L</option>
              <option>G</option>
              <option>D</option>
              <option>X</option>
              <option>W</option>
            </select>
          </div> -->
          <br />
          <button type='button' class='btn btn-primary btn-lg btn-block'>Submit</button>
        </div><!--/ query-sidebar -->
      </div><!--/row -->
    </div><!--/container -->
  </div><!--/map-wrap -->

  <script>
    // START TOGGLE MENU SETTINGS
    $('#menuToggle, .menu-close').click(function (e) {
      $('#menuToggle').toggleClass('active');
      $('body').toggleClass('body-push-toleft');
      $('#theMenu').toggleClass('menu-open');
    });

    $('#theMenu a').click(function (e) {
      $('i.menu-close').click();
    });
    // END TOGGLE MENU SETTINGS

    // START MAP SETTINGS
    var vis;
    var layers;

    var vizjson_url = '{{ admin_settings.vizjson_url }}';
    var pub_date = '{{ admin_settings.pub_date }}';
    var optional_note = '{{ admin_settings.optional_note }}';
    
    console.log('Loading CartoDB Viz JSON: ' + vizjson_url);
    console.log(pub_date);
    if (optional_note)
      console.log('Note: ' + optional_note);

    cartodb.createVis('map', vizjson_url)
    .done(function (_vis, _layers) {
      vis = _vis;
      layers = _layers;
    });
    // END MAP SETTINGS

    // START QUERY SETTINGS
    function get_query_ui(field_name, field_type, options) {
      // console.log((i+1) + ' ' + field_name + ', ' + field_type);
      var ui = $('<div id="' + field_name + '-query-ui" class="checkbox query-ui"></div>');
      ui.append('<label>' + '<input id="' + field_name + '-input" type="checkbox" />' + field_name + '</label>');
      return ui;
    }

    var query_fields = '{{ query_fields }}';
    for (var i = 0; i < query_fields.length; i++) {
      query_fields = query_fields.replace('&#39;', '"');
    }
    query_fields = JSON.parse(query_fields);
    for (var i = query_fields.length - 1; i >= 0; i--) {
      var ui = get_query_ui(query_fields[i].name, query_fields[i].type);
      $('#query-area').append(ui);
    }
    
    // var fields = [];
    // var values = [];

    // $('#query-sidebar input[type=checkbox]').click(function (e) {
    //   var field = $(this).attr('id').split('_')[0];
    //   var checked = $(this).prop('checked');
    //   var field_index = fields.indexOf(field);

    //   if (checked) { // CHECK
    //     if (field_index >= 0) { // EXISTING FIELD
    //       fields.splice(field_index, 1); // REMOVE IT FIRST
    //     }
    //     fields.push(field); // PUSH IT

    //     // ENABLE QUERY VALUE OPTIONS
    //     $(this).parent('label').parent('div').children('select').prop('disabled', false);
    //   }
    //   else { // UNCHECK
    //     fields.splice(field_index, 1); // REMOVE THE FIELD
    //     values.splice(field_index, 1); // REMOVE THE VALUE

    //     // DISABLE QUERY VALUE OPTIONS
    //     $(this).parent('label').parent('div').children('select').prop('disabled', true);
    //   }

    //   console.log(fields);
    //   console.log(values);
    // });

    // $('#query-sidebar select').change(function (e) {
    //   var field = $(this).attr('id').split('_')[0];
    //   var value = $(this).val();
    //   if (value == '-- Select --') return;
    //   var field_index = fields.indexOf(field);
    //   values.splice(field_index, 1, value);

    //   console.log(fields);
    //   console.log(values);
    // });

    // TODO: SEND QUERY
    // var sql = new cartodb.SQL({ user: 'cartodb_user' });
    // sql.execute("SELECT * FROM table_name WHERE id > {{id}}", { id: 3 })
    // .done(function(data) {
    //   console.log(data.rows);
    // })
    // .error(function(errors) {
    //   // errors contains a list of errors
    //   console.log("errors:" + errors);
    // });
    // END QUERY SETTINGS
    
    // START
    // $('#menuToggle').click();
    // setTimeout(function () {
    //   $('#menuToggle').click();
    // }, 500);
    // END
  </script>

{% endblock %}
